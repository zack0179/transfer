#!/usr/bin/env python
import os
import sys
import time
import argparse
from tools.tools import load, save
import numpy as np

def get_runs(path2mc):

  # load runs
  F=os.listdir(path2mc)
  F=[f for f in F if f.endswith('mc') if '-' in f]
  if len(F)==0:
    raise ValueError('*.mc files not found')

  runs={}
  cnt=0
  for f in F:
    runs[cnt]=load('%s/%s'%(path2mc,f))
    cnt+=1

  # combine samples
  nap=0
  samples=[] 
  nll=[]
  for k in runs:
    for p in runs[k]['samples']: samples.append(p)
    nll.extend(runs[k]['nll'])
    nap+=runs[k]['num active points'] 
  nll=np.array(nll)
  samples=np.array(samples)
  runs['all']={'samples':samples,'nll':nll,'num active points':nap}
  return runs

def get_ordered_samples(nap,nll,samples):
  nllc=np.copy(nll)
  I=np.argsort(nll)
  nll=nll[I]
  # regularize
  min_nll=np.amin(nll)
  samples=samples[I]
  likelihood=np.exp(-(nll-min_nll)) 
  x=np.array([((nap-1.)/nap)**i for i in range(likelihood.size+1)])[::-1]
  dx=(0.5*(x[1:]-x[:-1]))
  weights=likelihood*dx
  weights/=np.sum(weights)
  samples=np.array([samples[i] for i in range(weights.size) if weights[i]>0])
  weights=np.array([weights[i] for i in range(weights.size) if weights[i]>0])
  nll=np.array([nll[i] for i in range(weights.size) if weights[i]>0])
  return nll,weights,samples

if __name__=="__main__":

  ap = argparse.ArgumentParser()
  ap.add_argument('path2mc', help='path to *.mc files')
  args = ap.parse_args()

  runs=get_runs(args.path2mc)

  for k in runs:
    nap=runs[k]['num active points']
    nll=runs[k]['nll']
    samples=runs[k]['samples']
    nll,weights,samples = get_ordered_samples(nap,nll,samples)
    runs[k]={'nap':nap,'nll':nll,'samples':samples,'weights':weights}
    
  save(runs,'%s/summary.mc'%args.path2mc)


